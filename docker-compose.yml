version: '3.8'

services:
  dcv-server:
    build:
      context: ./dcv-server
      dockerfile: Dockerfile
    container_name: dcv-server
    hostname: dcv-server
    network_mode: "host"
    privileged: true
    environment:
      - ENV=brev
      - DISPLAY=:0
      - XDG_SESSION_TYPE=x11
    stop_signal: SIGRTMIN+3
    volumes:
      - dcv-home:/home/ubuntu
      - dcv-cache:/var/cache
      - /tmp/.X11-unix:/tmp/.X11-unix
    tmpfs:
      - /run
      - /run/lock
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility, compute, graphics, display]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "dcvserver"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  dcv-home:
    driver: local
  dcv-cache:
    driver: local
